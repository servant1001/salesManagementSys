<template>
    <div>
        <el-row class="titleBar">
            <el-col :span="24" class="title-col">
                <h2>ÂïÜÂìÅÂàóË°®</h2>
            </el-col>
        </el-row>

        <!-- Êü•Ë©¢ + ÊåâÈàïÂçÄ -->
        <div class="top-bar">
            <el-input v-model="searchQuery" placeholder="ÊêúÂ∞ãÂïÜÂìÅÂêçÁ®±ÊàñÁ∑®Ëôü" clearable class="search-input" />

            <el-select v-model="selectedVendor" placeholder="ÈÅ∏ÊìáÂª†ÂïÜ" clearable style="width: 180px;">
                <el-option
                    label="ÂÖ®ÈÉ®"
                    :value="null"
                />
                <el-option
                    v-for="vendor in vendorList"
                    :key="vendor.vendorId"
                    :label="vendor.vendorName"
                    :value="vendor.vendorId"
                />
            </el-select>

            <div class="button-group">
                <el-button type="primary" @click="toggleEditMode">
                    {{ editMode ? "ÈÄÄÂá∫Á∑®ËºØÊ®°Âºè" : "ÈÄ≤ÂÖ•Á∑®ËºØÊ®°Âºè" }}
                </el-button>
                <el-button type="success" @click="showAddDialog = true">
                    Êñ∞Â¢ûÂïÜÂìÅ
                </el-button>
                <el-button type="warning" @click="showBatchDialog = true">
                    ÊâπÈáèÊñ∞Â¢ûÂïÜÂìÅ
                </el-button>
                <el-button type="danger" @click="deleteSelectedProducts">
                    Âà™Èô§ÂãæÈÅ∏ÂïÜÂìÅ
                </el-button>
            </div>
        </div>

        <!-- ÂïÜÂìÅÂàóË°®Ë°®Ê†º -->
        <el-table
            :data="pagedProducts"
            style="width: 100%"
            border
            :class="tableThemeClass"
            :header-cell-style="{ background: `var(--table-header-bg)`, color: `var(--table-header-text)` }"
            @selection-change="handleSelectionChange"
            @sort-change="handleSortChange"
            ref="productTable"
        >

            <!-- checkboxÊ¨Ñ‰Ωç -->
            <el-table-column v-if="editMode" type="selection" width="55" align="center">
            </el-table-column>

            <!-- Â∫èËôüÊ¨Ñ‰Ωç -->
            <el-table-column label="#" width="50" align="center">
                <template #default="scope">
                    {{ (currentPage - 1) * pageSize + scope.$index + 1 }}
                </template>
            </el-table-column>

            <!-- Êìç‰ΩúÊ¨ÑÊï¥Ê¨ÑÈö®Á∑®ËºØÊ®°ÂºèÈ°ØÁ§∫ -->
            <el-table-column v-if="editMode" label="Êìç‰Ωú" width="210">
                <template #default="{ row }">
                    <div style="display: flex;">
                        <el-button type="primary" size="small" @click="openEditDialog(row)">Á∑®ËºØ</el-button>
                        <el-button type="warning" size="small" @click="copyProduct(row)">Ë§áË£Ω</el-button>
                        <el-button type="danger" size="small" @click="deleteProduct(row)">Âà™Èô§</el-button>
                    </div>
                </template>
            </el-table-column>

            <el-table-column prop="name" label="ÂïÜÂìÅÂêçÁ®±" min-width="180">
                <template #default="{ row }">
                    <template v-if="row.website">
                        <a :href="row.website" target="_blank" rel="noopener noreferrer"
                            style="color: #409eff; font-weight: 500; text-decoration: underline;">
                            {{ row.name }}
                        </a>
                    </template>
                    <template v-else>
                        {{ row.name }}
                    </template>
                </template>
            </el-table-column>

            <el-table-column prop="price" label="ÂÆöÂÉπ" min-width="70" />
            <el-table-column prop="sellingPrice" label="ÂîÆÂÉπ" min-width="70">
                <template #default="{ row }">
                    <span style="font-weight: bold;">{{ row.sellingPrice }} ÂÖÉ</span>
                </template>
            </el-table-column>
            <el-table-column prop="cost" label="ÊàêÊú¨" min-width="70" />
            <el-table-column prop="stock" label="Â∫´Â≠ò" min-width="70" />
            <el-table-column prop="code" label="ÂïÜÂìÅÁ∑®Ëôü" sortable min-width="140" />
            <el-table-column prop="supplierName" label="Âª†ÂïÜÂêçÁ®±" min-width="120" />
            <el-table-column prop="supplierCode" label="Âª†ÂïÜÁ∑®Ëôü" min-width="120" />
            <el-table-column prop="gtin" label="GTIN" min-width="120" />
            <el-table-column prop="website" label="Á∂≤Á´ô" min-width="70">
                <template #default="{ row }">
                    <a v-if="row.website" :href="row.website" target="_blank" rel="noopener noreferrer"
                        style="color: #409eff; text-decoration: underline;">ÈÄ£Áµê</a>
                </template>
            </el-table-column>
            <el-table-column prop="note" label="ÂÇôË®ª" min-width="120" />
            <el-table-column prop="createdBy" label="ÂâµÂª∫ËÄÖ" min-width="100" />
            <el-table-column prop="updatedBy" label="Êõ¥Êñ∞ËÄÖ" min-width="100" />
            <el-table-column prop="created" label="Êñ∞Â¢ûÊôÇÈñì" min-width="190" :formatter="formatDate" />
            <el-table-column prop="updated" label="Êõ¥Êñ∞ÊôÇÈñì" min-width="190" :formatter="formatDate" />
        </el-table>

        <!-- ÂàÜÈ†Å -->
        <el-pagination background layout="prev, pager, next, sizes, total" :total="totalProducts" :page-size="pageSize"
            :current-page.sync="currentPage" :page-sizes="[10, 20, 50, 100]" @size-change="handlePageSizeChange"
            @current-change="handlePageChange" style="margin-top: 20px; text-align: right;">
        </el-pagination>

        <div v-if="!filteredProducts.length" style="margin-top: 1rem">Êö´ÁÑ°ÂïÜÂìÅË≥áÊñô</div>

        <!-- Êñ∞Â¢ûÂïÜÂìÅÂ∞çË©±Ê°Ü -->
        <el-dialog title="Êñ∞Â¢ûÂïÜÂìÅ" v-model="showAddDialog" :width="'90%'" class="add-product-dialog">
            <el-form :model="newProduct" :rules="rules" ref="addForm" label-width="120px">
                <el-form-item label="GTIN" prop="gtin">
                    <div style="display: flex; gap: 10px;">
                        <el-input v-model="newProduct.gtin" placeholder="Ë´ãËº∏ÂÖ• GTIN" />
                        <el-button type="primary" @click="startScanNewProduct">ÊéÉÊèè</el-button>
                    </div>
                </el-form-item>

                <el-form-item label="ÂïÜÂìÅÂêçÁ®±" prop="name">
                    <el-input v-model="newProduct.name" />
                </el-form-item>

                <el-form-item label="ÂïÜÂìÅÁ∑®Ëôü" prop="code">
                    <el-input v-model="newProduct.code" placeholder="‰æãÂ¶ÇÔºöA001 ÊàñÊ¢ùÁ¢ºËôü" />
                </el-form-item>

                <el-form-item label="ÂÆöÂÉπ" prop="price">
                    <el-input type="number" min="0" v-model.number="newProduct.price" />
                </el-form-item>

                <el-form-item label="ÂîÆÂÉπ" prop="sellingPrice">
                    <el-input type="number" min="0" v-model.number="newProduct.sellingPrice" />
                </el-form-item>

                <el-form-item label="ÊàêÊú¨" prop="cost">
                    <el-input type="number" min="0" v-model.number="newProduct.cost" />
                </el-form-item>

                <el-form-item label="Â∫´Â≠ò" prop="stock">
                    <el-input-number :min="0" v-model.number="newProduct.stock" />
                </el-form-item>

                <el-form-item label="Âª†ÂïÜÂêçÁ®±" prop="supplierName">
                    <el-input v-model="newProduct.supplierName" />
                </el-form-item>

                <el-form-item label="Âª†ÂïÜÁ∑®Ëôü" prop="supplierCode">
                    <div style="display: flex; gap: 10px;">
                        <el-input v-model="newProduct.supplierCode" placeholder="Ë´ãËº∏ÂÖ•Âª†ÂïÜÁ∑®Ëôü" />
                        <el-button type="primary" @click="findVendorByCode">Êü•Ë©¢</el-button>
                    </div>
                </el-form-item>

                <!-- üÜï Á∂≤Á´ô -->
                <el-form-item label="Á∂≤Á´ô">
                    <el-input v-model="newProduct.website" placeholder="Ë´ãËº∏ÂÖ•Á∂≤Á´ôÈÄ£Áµê (‰æãÂ¶ÇÔºöhttps://example.com)" />
                </el-form-item>

                <!-- üÜï ÂÇôË®ª -->
                <el-form-item label="ÂÇôË®ª">
                    <el-input v-model="newProduct.note" placeholder="Ë´ãËº∏ÂÖ•ÂÇôË®ª" type="textarea" rows="2" />
                </el-form-item>
            </el-form>

            <template #footer>
                <el-button @click="showAddDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="submitAddProduct">Êñ∞Â¢û</el-button>
            </template>
        </el-dialog>


        <!-- Á∑®ËºØÂïÜÂìÅÂΩàÁ™ó -->
        <el-dialog title="Á∑®ËºØÂïÜÂìÅ" v-model="showEditDialog" :width="'90%'" class="edit-product-dialog">
            <el-form v-if="editProduct" :model="editProduct" label-width="120px">
                <el-form-item label="GTIN" prop="gtin"
                    :rules="[{ required: true, message: 'Ë´ãËº∏ÂÖ• GTIN', trigger: 'blur' }]">
                    <div style="display: flex; gap: 10px;">
                        <el-input v-model="editProduct.gtin" placeholder="Ë´ãËº∏ÂÖ• GTIN" :disabled="true"/>
                    </div>
                </el-form-item>

                <el-form-item label="ÂïÜÂìÅÂêçÁ®±">
                    <el-input v-model="editProduct.name" />
                </el-form-item>

                <el-form-item label="ÂïÜÂìÅÁ∑®Ëôü">
                    <el-input v-model="editProduct.code" />
                </el-form-item>

                <el-form-item label="ÂÆöÂÉπ">
                    <el-input type="number" min="0" v-model.number="editProduct.price" />
                </el-form-item>

                <el-form-item label="ÂîÆÂÉπ" prop="sellingPrice">
                    <el-input type="number" min="0" v-model.number="editProduct.sellingPrice" />
                </el-form-item>

                <el-form-item label="ÊàêÊú¨">
                    <el-input type="number" min="0" v-model.number="editProduct.cost" />
                </el-form-item>

                <el-form-item label="Â∫´Â≠ò">
                    <el-input-number :min="0" v-model.number="editProduct.stock" />
                </el-form-item>

                <el-form-item label="Âª†ÂïÜÂêçÁ®±">
                    <el-input v-model="editProduct.supplierName" />
                </el-form-item>

                <el-form-item label="Âª†ÂïÜÁ∑®Ëôü">
                    <el-input v-model="editProduct.supplierCode" />
                </el-form-item>

                <el-form-item label="Á∂≤Á´ô">
                    <el-input v-model="editProduct.website" placeholder="Ë´ãËº∏ÂÖ•Á∂≤Á´ôÈÄ£Áµê" />
                </el-form-item>

                <el-form-item label="ÂÇôË®ª">
                    <el-input v-model="editProduct.note" type="textarea" rows="2" />
                </el-form-item>
            </el-form>

            <template #footer>
                <el-button @click="showEditDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="saveEditProduct">‰øùÂ≠ò</el-button>
            </template>
        </el-dialog>

        <!-- üß© ÊâπÈáèÊñ∞Â¢ûÂïÜÂìÅÂΩàÁ™ó -->
        <el-dialog title="ÊâπÈáèÊñ∞Â¢ûÂïÜÂìÅ" v-model="showBatchDialog" :width="'90%'" class="batch-add-dialog">
            <el-form :model="batchBase" :rules="batchRules" ref="batchForm" label-width="120px"
                style="margin-bottom: 20px;">
                <el-form-item label="ÂÆöÂÉπ" prop="price">
                    <el-input type="number" min="0" v-model.number="batchBase.price" />
                </el-form-item>

                <el-form-item label="ÂîÆÂÉπ" prop="sellingPrice">
                    <el-input type="number" min="0" v-model.number="batchBase.sellingPrice" />
                </el-form-item>

                <el-form-item label="ÊàêÊú¨" prop="cost">
                    <el-input type="number" min="0" v-model.number="batchBase.cost" />
                </el-form-item>

                <el-form-item label="Â∫´Â≠ò" prop="stock">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <el-input-number :min="0" v-model.number="batchBase.stock" />
                        <el-button type="primary" size="small" @click="syncBatchStock">ÂêåÊ≠•Âà∞‰∏ãÊñπÂàóË°®</el-button>
                    </div>
                </el-form-item>

                <el-form-item label="Âª†ÂïÜÂêçÁ®±">
                    <el-input v-model="batchBase.supplierName" />
                </el-form-item>

                <el-form-item label="Âª†ÂïÜÁ∑®Ëôü">
                    <div style="display: flex; gap: 10px;">
                        <el-input v-model="batchBase.supplierCode" placeholder="Ë´ãËº∏ÂÖ•Âª†ÂïÜÁ∑®Ëôü" />
                        <el-button type="primary" @click="findVendorByCodeBatch">Êü•Ë©¢</el-button>
                    </div>
                </el-form-item>

                <el-form-item label="Á∂≤Á´ô">
                    <el-input v-model="batchBase.website" placeholder="Ë´ãËº∏ÂÖ•Á∂≤Á´ôÈÄ£Áµê" />
                </el-form-item>

                <el-form-item label="ÂÇôË®ª">
                    <el-input v-model="batchBase.note" type="textarea" rows="2" />
                </el-form-item>
            </el-form>

            <h4 style="margin-bottom: 10px;">ÂïÜÂìÅÊ∏ÖÂñÆ</h4>
            <div style="margin-bottom: 10px; display: flex; justify-content: flex-end;">
                <el-button type="primary" @click="addBatchRow">Êñ∞Â¢û‰∏ÄÂàó</el-button>
            </div>

            <el-table :data="batchList" border style="width: 100%">
                <el-table-column type="index" label="#" width="50" />

                <!-- GTIN Ê¨Ñ‰Ωç -->
                <el-table-column prop="gtin" label="GTIN" width="200">
                    <template #default="{ row }">
                        <div style="display: flex; gap: 5px;">
                            <el-input v-model="row.gtin" placeholder="Ë´ãËº∏ÂÖ• GTIN" />
                            <el-button type="primary" size="small" @click="startScanGTIN(row)">ÊéÉÊèè</el-button>
                        </div>
                    </template>
                </el-table-column>

                <!-- ÂïÜÂìÅÂêçÁ®± -->
                <el-table-column prop="name" label="ÂïÜÂìÅÂêçÁ®±" width="200">
                    <template #default="{ row }">
                        <el-input v-model="row.name" placeholder="ÂïÜÂìÅÂêçÁ®±" />
                    </template>
                </el-table-column>

                <!-- ÂïÜÂìÅÁ∑®Ëôü -->
                <el-table-column prop="code" label="ÂïÜÂìÅÁ∑®Ëôü" width="180">
                    <template #default="{ row }">
                        <el-input v-model="row.code" placeholder="ÂïÜÂìÅÁ∑®Ëôü" />
                    </template>
                </el-table-column>

                <!-- Â∫´Â≠òÊ¨Ñ‰Ωç -->
                <el-table-column prop="stock" label="Â∫´Â≠ò" width="130">
                    <template #default="{ row }">
                        <el-input-number style="width: 100px" v-model.number="row.stock" :min="0" />
                    </template>
                </el-table-column>

                <!-- Êìç‰Ωú -->
                <el-table-column label="Êìç‰Ωú">
                    <template #default="{ $index }">
                        <el-button type="danger" size="small" @click="removeBatchRow($index)">Âà™Èô§</el-button>
                    </template>
                </el-table-column>
            </el-table>

            <template #footer>
                <el-button @click="showBatchDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="submitBatchProducts">Êèê‰∫§</el-button>
            </template>
        </el-dialog>


        <!-- ÊéÉÊèèÂô®ÂΩàÁ™ó -->
        <el-dialog title="ÊéÉÊèèÊ¢ùÁ¢º" v-model="showScannerDialog" width="400px" destroy-on-close>
            <Scanner @onScan="handleScanResult" />
        </el-dialog>
    </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch } from "vue";
import { db } from "@/firebase";
import { ref as dbRef, onValue, update, push, remove, get, child } from "firebase/database";
import { ElMessage, ElMessageBox } from "element-plus";
import Scanner from "@/components/Scanner.vue";
import { useThemeStore } from "@/stores/theme";
import { useAuth } from "@/composables/useAuth";

const themeStore = useThemeStore();
const tableThemeClass = computed(() => (themeStore.isDarkTheme ? "table-dark" : "table-light"));
const { user } = useAuth();

interface Product {
    id: string;
    gtin: string;
    code: string;
    name: string;
    price: number;
    sellingPrice: number;
    cost: number;
    stock: number;
    supplierName: string;
    supplierCode: string;
    website?: string;
    note?: string;
    created: number;
    updated?: number;
    createdBy?: string;
    updatedBy?: string;
}

const products = ref<Record<string, Product>>({});
const editMode = ref(false);
const searchQuery = ref("");

// Êñ∞Â¢ûÂïÜÂìÅ
const showAddDialog = ref(false);
const showScannerDialog = ref(false);
const addForm = ref<any>(null);

const newProduct = ref<Omit<Product, "id" | "createdBy" | "updatedBy">>({
    gtin: "",
    code: "",
    name: "",
    price: 0,
    sellingPrice: 0,
    cost: 0,
    stock: 0,
    supplierName: "",
    supplierCode: "",
    website: "",
    note: "",
    created: Date.now(),
});

// È©óË≠âË¶èÂâá
const rules = {
    gtin: [{ required: true, message: "Ë´ãËº∏ÂÖ• GTIN", trigger: "blur" }],
    code: [{ required: true, message: "Ë´ãËº∏ÂÖ•ÂïÜÂìÅÁ∑®Ëôü", trigger: "blur" }],
    name: [{ required: true, message: "Ë´ãËº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±", trigger: "blur" }],
    price: [{ required: true, message: "Ë´ãËº∏ÂÖ•ÂÆöÂÉπ", trigger: "blur" }],
    sellingPrice: [{ required: true, message: "Ë´ãËº∏ÂÖ•ÂîÆÂÉπ", trigger: "blur" }],
    cost: [{ required: true, message: "Ë´ãËº∏ÂÖ•ÊàêÊú¨", trigger: "blur" }],
    stock: [{ required: true, message: "Ë´ãËº∏ÂÖ•Â∫´Â≠ò", trigger: "change" }],
};

// Á∑®ËºØÂΩàÁ™ó
const showEditDialog = ref(false);
const editProduct = ref<Product | null>(null);

const scanTargetRow = ref<any>(null);

function startScanGTIN(row: any) {
    scanTargetRow.value = row;
    showScannerDialog.value = true;
}

function startScanNewProduct() {
    scanTargetRow.value = newProduct.value;
    showScannerDialog.value = true;
}

// ÊéÉÊèèÊ¢ùÁ¢º
function handleScanResult(result: string) {
    if (scanTargetRow.value) {
        scanTargetRow.value.gtin = result; // Â∞áÊéÉÊèèÁµêÊûúÂ°´ÂÖ•Â∞çÊáâ row
        scanTargetRow.value = null; // Ê∏ÖÈô§ÁõÆÊ®ô
    } else if (editProduct.value) {
        editProduct.value.gtin = result;  // Á∑®ËºØÊ®°ÂºèÂ°´ÂÖ• GTIN
    } else {
        newProduct.value.gtin = result;   // Êñ∞Â¢ûÊ®°ÂºèÂ°´ÂÖ• GTIN
    }
    showScannerDialog.value = false;
}


function getCurrentUserDisplayName(): string | undefined {
    return user.value?.displayName ?? undefined;
}

function fetchProducts() {
    const productsRef = dbRef(db, "products");
    onValue(productsRef, (snapshot) => {
        const data = snapshot.val() || {};
        const result: Record<string, Product> = {};
        for (const [id, p] of Object.entries(data)) {
            const prod = p as Omit<Product, "id">;
            result[id] = { id, ...prod };
        }
        products.value = result;
    });
}

const sortedProductsArray = computed(() => Object.values(products.value).sort((a, b) => b.created - a.created));
const filteredProducts = computed(() => {
    let list = sortedProductsArray.value;

    // ÊñáÂ≠óÊêúÂ∞ã
    if (searchQuery.value) {
        const query = searchQuery.value.toLowerCase();
        list = list.filter(p =>
            [p.name, p.code].some(f => f?.toLowerCase().includes(query))
        );
    }

    // Âª†ÂïÜÈÅéÊøæ
    if (selectedVendor.value) {
        list = list.filter(p => p.supplierCode === selectedVendor.value);
    }

    return list;
});

function formatDate(row: Product, column?: any) {
    const timestamp = column?.property === "updated" ? row.updated : row.created;
    return timestamp ? new Date(timestamp).toLocaleString() : "";
}

function toggleEditMode() {
    editMode.value = !editMode.value;
}

function openEditDialog(product: Product) {
    editProduct.value = { ...product };
    showEditDialog.value = true;
}

// ÂñÆÁ≠ÜÊõ¥Êñ∞
async function saveEditProduct() {
    if (!editProduct.value) return;
    const now = Date.now();
    const currentUser = getCurrentUserDisplayName();

    const productRef = dbRef(db, `products/${editProduct.value.id}`);
    const updateData = {
        code: editProduct.value.code || "",
        gtin: editProduct.value.gtin || "",
        name: editProduct.value.name || "",
        price: editProduct.value.price ?? 0,
        sellingPrice: editProduct.value.sellingPrice ?? 0,
        cost: editProduct.value.cost ?? 0,
        stock: editProduct.value.stock ?? 0,
        supplierName: editProduct.value.supplierName || "",
        supplierCode: editProduct.value.supplierCode || "",
        website: editProduct.value.website || "",
        note: editProduct.value.note || "",
        updated: now,
        updatedBy: currentUser,
    };

    try {
        await update(productRef, updateData);
        ElMessage.success("‚úÖ ÂïÜÂìÅÊõ¥Êñ∞ÊàêÂäü");
        showEditDialog.value = false;
        editProduct.value = null;
    } catch (error) {
        console.error(error);
        ElMessage.error("‚ùå ÂïÜÂìÅÊõ¥Êñ∞Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶");
    }
}


// Âà™Èô§ÂâçÁ¢∫Ë™ç
function deleteProduct(product: Product) {
    if (!product.id) return;

    ElMessageBox.confirm(
        `Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${product.name}„ÄçÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`,
        "Âà™Èô§Á¢∫Ë™ç",
        {
            confirmButtonText: "Âà™Èô§",
            cancelButtonText: "ÂèñÊ∂à",
            type: "warning",
        }
    )
        .then(() => {
            const productRef = dbRef(db, `products/${product.id}`);
            remove(productRef)
                .then(() => ElMessage.success("Âà™Èô§ÊàêÂäü"))
                .catch(console.error);
        })
        .catch(() => { });
}

async function checkGTINExists(gtin: string, excludeId?: string): Promise<boolean> {
    const productsRef = dbRef(db, "products");
    const snapshot = await get(productsRef);
    if (!snapshot.exists()) return false;

    const productsData = snapshot.val() as Record<string, Product>;
    return Object.values(productsData).some(p => p.gtin === gtin && p.id !== excludeId);
}

// Êñ∞Â¢ûÂïÜÂìÅÔºàÂøÖÂ°´È©óË≠â + Á∑®ËôüÊ™¢Êü•Ôºâ
async function submitAddProduct() {
    addForm.value.validate(async (valid: boolean) => {
        if (!valid) {
            ElMessage.warning("Ë´ãÂÆåÊï¥Â°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç");
            return;
        }

        // üîç Ê™¢Êü• GTIN ÊòØÂê¶ÈáçË§á
        if (await checkGTINExists(newProduct.value.gtin)) {
            ElMessage.error(`GTIN„Äå${newProduct.value.gtin}„ÄçÂ∑≤Â≠òÂú®ÔºåË´ã‰øÆÊîπÂæåÂÜçÊñ∞Â¢û`);
            return;
        }

        // üîç Ê™¢Êü•ÂïÜÂìÅÁ∑®ËôüÊòØÂê¶ÈáçË§á
        const codeExists = await checkProductCodeExists(newProduct.value.code);
        if (codeExists) {
            ElMessage.error(`ÂïÜÂìÅÁ∑®Ëôü„Äå${newProduct.value.code}„ÄçÂ∑≤Â≠òÂú®ÔºåË´ã‰øÆÊîπÂæåÂÜçÊñ∞Â¢û`);
            return;
        }

        addProduct();
    });
}

async function checkProductCodeExists(code: string): Promise<boolean> {
    const productsRef = dbRef(db, "products");
    const snapshot = await get(productsRef);
    if (!snapshot.exists()) return false;

    const productsData = snapshot.val() as Record<string, Product>;
    return Object.values(productsData).some((p) => p.code === code);
}


function copyProduct(product: Product) {
    // Ë§áË£ΩÂéüÂïÜÂìÅË≥áÊñôÔºå‰ΩÜ id ÂÖà‰∏çÂ∏∂ÔºåÂêçÁ®±Âä†‰∏ä "(Ë§áË£Ω)"
    editProduct.value = {
        ...product,
        id: undefined, // Êñ∞Â¢ûÊôÇ Firebase ÊúÉËá™ÂãïÁîüÊàê id
        name: `${product.name} (Ë§áË£Ω)`,
        created: Date.now(),
        createdBy: getCurrentUserDisplayName(),
    } as unknown as Product;

    showEditDialog.value = true; // È°ØÁ§∫Á∑®ËºØÂΩàÁ™ó
}

function addProduct() {
    const currentUser = getCurrentUserDisplayName();
    const productsRef = dbRef(db, "products");
    const productData = { ...newProduct.value, created: Date.now(), createdBy: currentUser };
    const newRef = push(productsRef);
    const id = newRef.key!;
    update(newRef, { ...productData, id })
        .then(() => {
            showAddDialog.value = false;
            newProduct.value = {
                gtin: "",
                code: "",
                name: "",
                price: 0,
                sellingPrice: 0,
                cost: 0,
                stock: 0,
                supplierName: "",
                supplierCode: "",
                website: "",
                note: "",
                created: Date.now(),
            };
        })
        .catch(console.error);
}

interface Vendor {
    vendorId: string;
    vendorName: string;
    createdBy?: string;
    updatedBy?: string;
    createdAt?: number;
    updatedAt?: number;
}

// Êü•Ë©¢Âª†ÂïÜÂêçÁ®±
async function findVendorByCode() {
    const code = newProduct.value.supplierCode.trim();
    if (!code) {
        ElMessage.warning("Ë´ãÂÖàËº∏ÂÖ•Âª†ÂïÜÁ∑®Ëôü");
        return;
    }

    const vendorsRef = dbRef(db);
    const snapshot = await get(child(vendorsRef, "vendors"));

    if (!snapshot.exists()) {
        ElMessage.error("ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïÂª†ÂïÜË≥áÊñô");
        return;
    }

    const vendors = snapshot.val() as Record<string, Vendor>; // ‚úÖ ÊòéÁ¢∫ÂûãÂà•
    const matched = Object.values(vendors).find(
        (v) => v.vendorId?.toLowerCase() === code.toLowerCase()
    );

    if (matched) {
        newProduct.value.supplierName = matched.vendorName;
        ElMessage.success(`Â∑≤ÊâæÂà∞Âª†ÂïÜÔºö${matched.vendorName}`);
    } else {
        newProduct.value.supplierName = "";
        ElMessage.warning("Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÂª†ÂïÜ");
    }
}

// üß© ÊâπÈáèÊñ∞Â¢ûÂïÜÂìÅ
const showBatchDialog = ref(false);
const batchBase = ref({
    price: 0,
    sellingPrice: 0,
    cost: 0,
    stock: 0,
    supplierName: "",
    supplierCode: "",
    website: "",
    note: "",
});
const batchList = ref<{ gtin: string; code: string; name: string, stock: number }[]>([]);

const batchForm = ref<any>(null);

const batchRules = {
    price: [{ required: true, message: "Ë´ãËº∏ÂÖ•ÂÆöÂÉπ", trigger: "blur" }],
    sellingPrice: [{ required: true, message: "Ë´ãËº∏ÂÖ•ÂîÆÂÉπ", trigger: "blur" }],
    cost: [{ required: true, message: "Ë´ãËº∏ÂÖ•ÊàêÊú¨", trigger: "blur" }],
    stock: [{ required: true, message: "Ë´ãËº∏ÂÖ•Â∫´Â≠ò", trigger: "change" }],
};


function addBatchRow() {
    batchList.value.push({ gtin: "", code: "", name: "", stock: batchBase.value.stock ?? 0 });
}

function removeBatchRow(index: number) {
    batchList.value.splice(index, 1);
}

async function findVendorByCodeBatch() {
    const code = batchBase.value.supplierCode.trim();
    if (!code) {
        ElMessage.warning("Ë´ãÂÖàËº∏ÂÖ•Âª†ÂïÜÁ∑®Ëôü");
        return;
    }

    const vendorsRef = dbRef(db);
    const snapshot = await get(child(vendorsRef, "vendors"));
    if (!snapshot.exists()) {
        ElMessage.error("ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïÂª†ÂïÜË≥áÊñô");
        return;
    }

    const vendors = snapshot.val() as Record<string, Vendor>;
    const matched = Object.values(vendors).find(
        (v) => v.vendorId?.toLowerCase() === code.toLowerCase()
    );

    if (matched) {
        batchBase.value.supplierName = matched.vendorName;
        ElMessage.success(`Â∑≤ÊâæÂà∞Âª†ÂïÜÔºö${matched.vendorName}`);
    } else {
        batchBase.value.supplierName = "";
        ElMessage.warning("Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÂª†ÂïÜ");
    }
}

async function submitBatchProducts() {
    batchForm.value.validate(async (valid: boolean) => {
        if (!valid) {
            ElMessage.warning("Ë´ãÂÆåÊï¥Â°´ÂØ´ÊâπÈáèÊñ∞Â¢ûÁöÑÂü∫Êú¨Ê¨Ñ‰Ωç");
            return;
        }

        if (!batchList.value.length) {
            ElMessage.warning("Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÁ≠ÜÂïÜÂìÅ");
            return;
        }

        const currentUser = getCurrentUserDisplayName();
        const productsRef = dbRef(db, "products");
        const now = Date.now();

        // ÂÖàÊäìÁèæÊúâÂïÜÂìÅË≥áÊñô‰ª•Ê™¢Êü•ÈáçË§á
        const snapshot = await get(productsRef);
        const existingProducts = snapshot.exists() ? (snapshot.val() as Record<string, Product>) : {};
        const existingCodes = new Set(Object.values(existingProducts).map(p => p.code));
        const existingGTINs = new Set(Object.values(existingProducts).map(p => p.gtin));

        // ÊâæÂá∫ÈáçË§áÁöÑÁ∑®ËôüÊàñ GTIN
        const duplicateCodes: string[] = [];
        const duplicateGTINs: string[] = [];
        for (const item of batchList.value) {
            if (!item.code || !item.name || !item.gtin) continue;
            if (existingCodes.has(item.code)) duplicateCodes.push(item.code);
            if (existingGTINs.has(item.gtin)) duplicateGTINs.push(item.gtin);
        }

        // üö´ Ëã•ÊúâÈáçË§áÔºå‰∏çÈÄÅÂá∫
        if (duplicateCodes.length > 0) {
            ElMessage.error(`‰ª•‰∏ãÂïÜÂìÅÁ∑®ËôüÂ∑≤Â≠òÂú®ÔºåË´ã‰øÆÊîπÂæåÂÜçÊèê‰∫§Ôºö${duplicateCodes.join(", ")}`);
            return;
        }
        if (duplicateGTINs.length > 0) {
            ElMessage.error(`‰ª•‰∏ã GTIN Â∑≤Â≠òÂú®ÔºåË´ã‰øÆÊîπÂæåÂÜçÊèê‰∫§Ôºö${duplicateGTINs.join(", ")}`);
            return;
        }

        // Ê™¢Êü•ÊòØÂê¶Ëá≥Â∞ëÊúâ‰∏ÄÁ≠ÜÂÆåÊï¥ÂïÜÂìÅ
        const validList = batchList.value.filter(item => item.code && item.name && item.gtin);
        if (!validList.length) {
            ElMessage.warning("Ë´ãËá≥Â∞ëÂ°´ÂØ´‰∏ÄÁ≠ÜÂÆåÊï¥ÂïÜÂìÅÔºàÁ∑®Ëôü„ÄÅÂêçÁ®±Ëàá GTINÔºâ");
            return;
        }

        // ÁµÑÂêàË≥áÊñô
        const updates: Record<string, Product> = {};
        for (const item of validList) {
            const newRef = push(productsRef);
            const id = newRef.key!;
            updates[id] = {
                id,
                code: item.code,
                gtin: item.gtin,           // Êñ∞Â¢û GTIN
                name: item.name,
                price: batchBase.value.price,
                sellingPrice: batchBase.value.sellingPrice,
                cost: batchBase.value.cost,
                stock: item.stock,
                supplierName: batchBase.value.supplierName,
                supplierCode: batchBase.value.supplierCode,
                website: batchBase.value.website,
                note: batchBase.value.note,
                created: now,
                createdBy: currentUser,
            };
        }

        try {
            await update(productsRef, updates);
            ElMessage.success(`ÊàêÂäüÊñ∞Â¢û ${validList.length} Á≠ÜÂïÜÂìÅ`);
            showBatchDialog.value = false;
            batchList.value = [];
            batchBase.value = {
                price: 0,
                sellingPrice: 0,
                cost: 0,
                stock: 0,
                supplierName: "",
                supplierCode: "",
                website: "",
                note: "",
            };
        } catch (err) {
            console.error(err);
            ElMessage.error("ÊâπÈáèÊñ∞Â¢ûÂ§±Êïó");
        }
    });
}

// Áî®ÊñºÂ≠òÊîæÂ∑≤ÂãæÈÅ∏ÁöÑÂïÜÂìÅ
const selectedProducts = ref<Product[]>([]);
const productTable = ref<any>(null);

// Áõ£ËÅΩÂãæÈÅ∏ËÆäÂåñ
function handleSelectionChange(val: Product[]) {
    selectedProducts.value = val;
}

// ÊâπÊ¨°Âà™Èô§ÂãæÈÅ∏ÂïÜÂìÅ
function deleteSelectedProducts() {
    if (!selectedProducts.value.length) {
        ElMessage.warning("Ë´ãÂÖàÂãæÈÅ∏Ë¶ÅÂà™Èô§ÁöÑÂïÜÂìÅ");
        return;
    }

    ElMessageBox.confirm(
        `Á¢∫ÂÆöË¶ÅÂà™Èô§ ${selectedProducts.value.length} Á≠ÜÂïÜÂìÅÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`,
        "Âà™Èô§Á¢∫Ë™ç",
        {
            confirmButtonText: "Âà™Èô§",
            cancelButtonText: "ÂèñÊ∂à",
            type: "warning",
        }
    )
        .then(async () => {
            try {
                const updates: Record<string, null> = {};
                selectedProducts.value.forEach((p) => {
                    if (p.id) updates[p.id] = null; // Firebase Âà™Èô§
                });

                await update(dbRef(db, "products"), updates);
                ElMessage.success("Â∑≤Âà™Èô§ÈÅ∏‰∏≠ÁöÑÂïÜÂìÅ");
                selectedProducts.value = [];
                // Ê∏ÖÈô§Ë°®Ê†ºÂãæÈÅ∏
                productTable.value.clearSelection();
            } catch (err) {
                console.error(err);
                ElMessage.error("Âà™Èô§Â§±Êïó");
            }
        })
        .catch(() => { });
}

// ÂàÜÈ†ÅÊéßÂà∂
const currentPage = ref(1);
const pageSize = ref(10); // ÊØèÈ†ÅÈ°ØÁ§∫Êï∏ÈáèÔºåÂèØ‰øÆÊîπ
const totalProducts = computed(() => filteredProducts.value.length);

// Ë®àÁÆóÂàÜÈ†ÅÂæåË¶ÅÈ°ØÁ§∫ÁöÑË≥áÊñô
const pagedProducts = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value;
  return sortedFilteredProducts.value.slice(start, start + pageSize.value);
});

// ÂàÜÈ†Å‰∫ã‰ª∂
function handlePageChange(page: number) {
    currentPage.value = page;
}

function handlePageSizeChange(size: number) {
    pageSize.value = size;
    currentPage.value = 1; // ÈáçÊñ∞ÂõûÂà∞Á¨¨1È†Å
}

// ÊéíÂ∫èÁãÄÊÖã
const sortState = ref<{ prop: string; order: 'ascending' | 'descending' | null }>({
  prop: '',
  order: null
});

// ÊéíÂ∫è‰∫ã‰ª∂ËôïÁêÜ
function handleSortChange({ prop, order }: any) {
  sortState.value = { prop, order };
}

// ÊéíÂ∫èÂæåË≥áÊñô
const sortedFilteredProducts = computed(() => {
  const list = [...filteredProducts.value];
  const { prop, order } = sortState.value;

  if (!prop || !order) return list;

  return list.sort((a, b) => {
    const key = prop as keyof Product;   // ‚úÖ Êñ∑Ë®Ä
    const aVal = a[key] ?? '';
    const bVal = b[key] ?? '';

    if (typeof aVal === 'number' && typeof bVal === 'number') {
      return order === 'ascending' ? aVal - bVal : bVal - aVal;
    }

    return order === 'ascending'
      ? String(aVal).localeCompare(String(bVal))
      : String(bVal).localeCompare(String(aVal));
  });
});

const selectedVendor = ref<string | null>(null); // ÈÅ∏ÊìáÁöÑÂª†ÂïÜÁ∑®Ëôü
const vendorList = ref<Vendor[]>([]); // Âª†ÂïÜÂàóË°®

// ÂèñÂæóÂª†ÂïÜÂàóË°®
async function fetchVendors() {
    const vendorsRef = dbRef(db, "vendors");
    const snapshot = await get(vendorsRef);
    if (snapshot.exists()) {
        const data = snapshot.val() as Record<string, Vendor>;
        vendorList.value = Object.values(data);
    } else {
        vendorList.value = [];
    }
}

watch(selectedVendor, () => {
  // ÊØèÊ¨°ÂàáÊèõÂª†ÂïÜÔºåÊéíÂ∫èÈáçÁΩÆÁÇ∫ÂïÜÂìÅÁ∑®ËôüÁî±Â∞èÂà∞Â§ß
  sortState.value = { prop: "code", order: "ascending" };
});

function syncBatchStock() {
    if (!batchList.value.length) {
        ElMessage.warning("ÂàóË°®‰∏≠Ê≤íÊúâ‰ªª‰ΩïÂïÜÂìÅÔºåÁÑ°Ê≥ïÂêåÊ≠•Â∫´Â≠ò");
        return;
    }

    const stockValue = batchBase.value.stock ?? 0;
    batchList.value.forEach(item => {
        item.stock = stockValue;
    });
    ElMessage.success(`Â∑≤Â∞áÂ∫´Â≠òÂêåÊ≠•ÁÇ∫ ${stockValue}`);
}

// Âú® onMounted ‰∏≠ÂëºÂè´
onMounted(() => {
    fetchProducts();
    fetchVendors();
});
</script>

<style scoped>
.titleBar {
    margin: 0 0 10px 0;
}

.title-col {
    text-align: left;
}

.title-col h2 {
    margin: 0;
    font-weight: 600;
}

.top-bar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
    margin-bottom: 1rem;
}

.search-input {
    flex: 1;
    min-width: 150px;
    max-width: 300px;
}

.button-group {
    display: flex;
}

.batch-dialog .el-table th,
.batch-dialog .el-table td {
    text-align: center;
}
</style>
