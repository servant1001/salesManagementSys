<template>
    <div class="sales-page">
        <el-row class="titleBar">
            <el-col :span="24" class="title-col">
                <h2>Èä∑ÂîÆÁ¥ÄÈåÑ</h2>
            </el-col>
        </el-row>

        <div class="top-bar">
            <!-- ÊêúÂ∞ãÊ°Ü -->
            <el-input v-model="searchKeyword" placeholder="ÊêúÂ∞ãÂïÜÂìÅÂêçÁ®±" clearable @input="filterSales"
                class="search-input" />
            <div class="action-row">
                <el-date-picker style="margin-right: 10px; width: 100%;" v-model="selectedMonth" type="month"
                    placeholder="ÈÅ∏ÊìáÂπ¥Êúà" format="YYYY-MM" value-format="YYYY-MM" clearable
                    @change="() => loadSalesByMonth(selectedMonth)" class="date-picker" />
                <el-button style="max-width: 120px;" :type="showActions ? 'warning' : 'info'" @click="toggleEditMode">
                    {{ showActions ? 'ÈÄÄÂá∫Á∑®ËºØÊ®°Âºè' : 'ÈÄ≤ÂÖ•Á∑®ËºØÊ®°Âºè' }}
                </el-button>
            </div>
        </div>

        <el-row class="statsBar" style="
            display: flex;
            flex-wrap: wrap;       /* ÊâãÊ©üÊùøÂèØÊèõË°å */
            gap: 20px;             /* Ê¨Ñ‰ΩçÈñìË∑ù */
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            justify-content: flex-start; /* Êï¥ÂÄã row Èù†Â∑¶ */
        ">
            <div>Á∏ΩÈä∑ÂîÆÈ°çÔºö{{ totalFilteredSales }} ÂÖÉ</div>
            <div>Á∏ΩÊØõÂà©Ôºö{{ totalFilteredProfit }} ÂÖÉ</div>
            <div>‰ªäÊó•Èä∑ÂîÆÈ°çÔºö{{ todaySales }} ÂÖÉ</div>
            <div>‰ªäÊó•ÊØõÂà©Ôºö{{ todayProfit }} ÂÖÉ</div>
        </el-row>

        <el-table v-if="filteredSales.length" :data="filteredSales" border style="width:100%">
            <!-- ‚úÖ Â∫èËôüÊ¨Ñ -->
            <el-table-column label="#" width="50" align="center" fixed="left">
                <template #default="{ $index }">
                    {{ $index + 1 }}
                </template>
            </el-table-column>

            <!-- ‚úÖ Êìç‰ΩúÊ¨ÑÔºàÂè™ÊúâÂú®Á∑®ËºØÊ®°ÂºèÊôÇÈ°ØÁ§∫Ôºâ -->
            <el-table-column v-if="showActions" fixed="left" label="Êìç‰Ωú" width="80">
                <template #default="{ row }">
                    <el-button size="small" type="danger" @click="deleteSale(row)">Âà™Èô§</el-button>
                </template>
            </el-table-column>

            <el-table-column prop="timestamp" label="ÊôÇÈñì" width="170">
                <template #default="{ row }">{{ formatDate(row.timestamp) }}</template>
            </el-table-column>

            <el-table-column prop="total" label="Á∏ΩÈáëÈ°ç" width="100">
                <template #default="{ row }">
                    <div v-if="editingRow === row">
                        <el-input-number v-model="row.total" :min="0" size="small" />
                    </div>
                    <div v-else style="font-size: 20px; font-weight: bold;">
                        {{ row.total }} ÂÖÉ
                    </div>
                </template>
            </el-table-column>

            <el-table-column prop="totalProfit" label="Á∏ΩÊØõÂà©" width="100">
                <template #default="{ row }">
                    <div v-if="editingRow === row">
                        <el-input-number v-model="row.totalProfit" size="small" />
                    </div>
                    <div v-else>
                        <span
                            :style="{ color: (row.totalProfit ?? 0) >= 0 ? '#67c23a' : '#fc0000', fontWeight: 'bold', fontSize: '20px' }">
                            {{ row.totalProfit ?? 0 }} ÂÖÉ
                        </span>
                    </div>
                </template>
            </el-table-column>

            <el-table-column prop="operator" label="Êìç‰Ωú‰∫∫Âì°" width="100" />
            <el-table-column label="ÂïÜÂìÅÊòéÁ¥∞" width="120">
                <template #default="{ row }">
                    <el-button type="primary" size="mini"
                        @click="showDetails(row.items, row.operator, row.total, row.totalProfit, row.id)">
                        ÂïÜÂìÅÊòéÁ¥∞
                    </el-button>
                </template>
            </el-table-column>
            <el-table-column prop="updater" label="‰øÆÊîπËÄÖ" />
        </el-table>

        <div v-else>Â∞öÁÑ°Èä∑ÂîÆÁ¥ÄÈåÑ</div>

        <!-- ÂΩàÁ™óÈ°ØÁ§∫ÂïÜÂìÅÊòéÁ¥∞ -->
        <el-dialog title="ÂïÜÂìÅÊòéÁ¥∞" v-model="dialogVisible" width="90%" @close="onDetailDialogClose">
            <!-- Êìç‰Ωú‰∫∫Âì°ËàáÁ∏ΩÈáëÈ°ç -->
            <div class="detail-header">
                <!-- Â∑¶ÂÅ¥Áµ±Ë®àË≥áË®ä -->
                <el-card shadow="hover" class="summary-card">
                    <div class="summary-content">
                        <div class="summary-item"><strong>üí∞ Èä∑ÂîÆÔºö</strong><span class="highlight">{{ selectedTotal }}
                                ÂÖÉ</span>
                        </div>
                        <div class="summary-item"><strong>üìà ÊØõÂà©Ôºö</strong><span class="highlight profit">{{
                            selectedProfit }}
                                ÂÖÉ</span></div>
                        <div class="summary-item"><strong>üë§ ‰∫∫Âì°Ôºö</strong>{{ selectedOperator }}</div>
                    </div>
                </el-card>

                <!-- Âè≥ÂÅ¥ÊåâÈàï -->
                <div class="summary-actions">
                    <el-button size="small" type="primary" @click="addNewDetailItem">
                        Êñ∞Â¢ûÂïÜÂìÅ
                    </el-button>
                    <el-button style="margin: 0;" size="small" :type="showDetailActions ? 'warning' : 'info'"
                        @click="toggleDetailEditMode">
                        {{ showDetailActions ? 'ÈÄÄÂá∫Á∑®ËºØÊ®°Âºè' : 'ÈÄ≤ÂÖ•Á∑®ËºØÊ®°Âºè' }}
                    </el-button>
                </div>
            </div>



            <el-table :data="selectedItems" border style="width: 100%;" size="small">
                <!-- Â∫èËôüÊ¨Ñ‰Ωç -->
                <el-table-column label="#" width="50" align="center">
                    <template #default="{ $index }">
                        {{ $index + 1 }}
                    </template>
                </el-table-column>

                <el-table-column v-if="showDetailActions" label="Êìç‰Ωú" width="150">
                    <template #default="{ row }">
                        <!-- Á∑®ËºØÊ®°Âºè -->
                        <div v-if="editingDetailRow === row">
                            <el-button size="mini" type="primary" @click="saveDetailEdit(row)">
                                ÂÑ≤Â≠ò
                            </el-button>
                            <el-button size="mini" type="warning" @click="editingDetailRow = null">
                                ÂèñÊ∂à
                            </el-button>
                        </div>

                        <!-- ÈùûÁ∑®ËºØÊ®°Âºè -->
                        <div v-else>
                            <el-button size="mini" type="primary" @click="editingDetailRow = row">
                                Á∑®ËºØ
                            </el-button>
                            <el-button size="mini" type="danger" @click="deleteDetailItem(row)">
                                Âà™Èô§
                            </el-button>
                        </div>
                    </template>
                </el-table-column>

                <!-- ÂïÜÂìÅÂúñÁâáÊ¨Ñ -->
                <el-table-column label="ÂïÜÂìÅÂúñÁâá" width="120" align="center">
                    <template #default="{ row }">
                        <div
                            style="width: 100px; height: 100px; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f5f5f5;">
                            <img v-if="row.imageUrl" :src="row.imageUrl" alt="ÂïÜÂìÅÂúñÁâá"
                                style="width: 100%; height: 100%; object-fit: cover;" />
                            <el-icon v-else style="font-size: 32px; color: #ccc;">
                                <Picture />
                            </el-icon>
                        </div>
                    </template>
                </el-table-column>

                <el-table-column prop="name" label="ÂïÜÂìÅÂêçÁ®±">
                    <template #default="{ row }">
                        <div v-if="editingDetailRow === row">
                            <el-input v-model="row.name" size="small" placeholder="Ëº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±" />
                        </div>
                        <div v-else>
                            <a v-if="row.website" :href="row.website" target="_blank"
                                style="color: #409eff; text-decoration: none;">
                                {{ row.name }}
                            </a>
                            <span v-else>{{ row.name }}</span>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column prop="code" label="ÂïÜÂìÅÁ∑®Ëôü" width="120">
                    <template #default="{ row }">
                        <div v-if="editingDetailRow === row">
                            <el-input v-model="row.code" size="small" placeholder="Ëº∏ÂÖ•ÂïÜÂìÅÁ∑®Ëôü" />
                        </div>
                        <div v-else>{{ row.code }}</div>
                    </template>
                </el-table-column>

                <el-table-column prop="gtin" label="GTIN" width="120">
                    <template #default="{ row }">
                        <div v-if="editingDetailRow === row">
                            <el-input v-model="row.gtin" size="small" placeholder="Ëº∏ÂÖ• GTIN" />
                        </div>
                        <div v-else>{{ row.gtin }}</div>
                    </template>
                </el-table-column>
                <el-table-column prop="sellingPrice" label="ÂîÆÂÉπ" width="120">
                    <template #default="{ row }">
                        <div v-if="editingDetailRow === row">
                            <el-input-number style="width: 100px;" v-model="row.sellingPrice" :min="0" size="small" />
                        </div>
                        <div v-else>{{ row.sellingPrice }} ÂÖÉ</div>
                    </template>
                </el-table-column>

                <el-table-column prop="quantity" label="Êï∏Èáè" width="120">
                    <template #default="{ row }">
                        <div v-if="editingDetailRow === row">
                            <el-input-number style="width: 100px;" v-model="row.quantity" :min="0" size="small" />
                        </div>
                        <div v-else>{{ row.quantity }}</div>
                    </template>
                </el-table-column>

                <el-table-column label="Â∞èË®à" width="120">
                    <template #default="{ row }">{{ row.sellingPrice * row.quantity }} ÂÖÉ</template>
                </el-table-column>

                <el-table-column prop="price" label="ÂÆöÂÉπ" width="100" />
                <el-table-column prop="cost" label="ÊàêÊú¨" width="100" />
                <el-table-column prop="estimatedProfit" label="ÊØõÂà©(ÂñÆÂÄã)" width="120">
                    <template #default="{ row }">
                        <span :style="{ color: (row.sellingPrice - row.cost) >= 0 ? '#67c23a' : '#fc0000' }">
                            {{ (row.sellingPrice - row.cost).toFixed(0) }} ÂÖÉ
                        </span>
                    </template>
                </el-table-column>
                <el-table-column label="È†ê‰º∞Á∏ΩÊØõÂà©" width="120">
                    <template #default="{ row }">
                        <span
                            :style="{ color: (row.sellingPrice - row.cost) >= 0 ? '#67c23a' : '#fc0000', fontWeight: 'bold' }">
                            {{ ((row.sellingPrice - row.cost) * row.quantity).toFixed(0) }} ÂÖÉ
                        </span>
                    </template>
                </el-table-column>

                <el-table-column prop="website" label="Á∂≤Á´ôÈÄ£Áµê" width="180">
                    <template #default="{ row }">
                        <div v-if="editingDetailRow === row">
                            <el-input v-model="row.website" size="small" placeholder="Ëº∏ÂÖ•Á∂≤Á´ôÈÄ£Áµê" />
                        </div>
                        <div v-else>
                            <a v-if="row.website" :href="row.website" target="_blank" rel="noopener noreferrer"
                                style="color: #409eff; text-decoration: underline;">ÈÄ£Áµê</a>
                            <span v-else>-</span>
                        </div>
                    </template>
                </el-table-column>
            </el-table>
        </el-dialog>

    </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from "vue";
import { db } from "@/firebase";
import { query, orderByChild, startAt, endAt, get, child, ref as dbRef, remove, update } from "firebase/database";
import { ElMessage, ElMessageBox } from "element-plus";
import { Picture } from "@element-plus/icons-vue";
import { useAuth } from "@/composables/useAuth";
const { user } = useAuth();

interface SaleItem {
    barcode: string;
    gtin: string;
    code: string;
    name: string;
    price: number;
    sellingPrice: number;
    quantity: number;
    cost?: number;
    supplierName?: string;
    supplierCode?: string;
    imageUrl?: string;
}

interface Sale {
    id?: string;
    timestamp: number;
    total: number;
    totalProfit?: number;
    items: SaleItem[];
    operator: string;
}

const sales = ref<Sale[]>([]);
const filteredSales = ref<Sale[]>([]);

const selectedItems = ref<SaleItem[]>([]);
const selectedOperator = ref("");
const selectedTotal = ref(0);
const selectedProfit = ref(0);
const dialogVisible = ref(false);

const searchKeyword = ref("");

const showActions = ref(false); // ‚úÖ ÊéßÂà∂Á∑®ËºØÊ®°Âºè

const editingRow = ref<Sale | null>(null); // Ê≠£Âú®Á∑®ËºØÁöÑË°å
// ‚úÖ ÂàáÊèõÁ∑®ËºØÊ®°Âºè
function toggleEditMode() {
    showActions.value = !showActions.value;
}

// ÂèñÂæóË®≠ÂÇôË≥áË®ä
function getDeviceInfoShort(): string {
    const ua = navigator.userAgent;
    const platform = navigator.platform;

    // Á∞°ÂñÆÂà§Êñ∑ Chrome / Firefox / Edge / Safari
    let browser = "Êú™Áü•ÁÄèË¶ΩÂô®";
    if (ua.includes("Chrome")) browser = "Chrome";
    else if (ua.includes("Firefox")) browser = "Firefox";
    else if (ua.includes("Edg")) browser = "Edge";
    else if (ua.includes("Safari")) browser = "Safari";

    return `${browser} / ${platform}`;
}

// ‚úÖ Âà™Èô§Èä∑ÂîÆÁ¥ÄÈåÑ
async function deleteSale(sale: Sale) {
    try {
        await ElMessageBox.confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÈä∑ÂîÆÁ¥ÄÈåÑÂóéÔºü", "Âà™Èô§Á¢∫Ë™ç", {
            confirmButtonText: "Á¢∫ÂÆöÂà™Èô§",
            cancelButtonText: "ÂèñÊ∂à",
            type: "warning",
        });

        if (sale.id) {
            await remove(child(dbRef(db), `sales/${sale.id}`));
            ElMessage.success("Âà™Èô§ÊàêÂäü");
            await loadSalesByMonth(selectedMonth.value);
        } else {
            ElMessage.error("Êâæ‰∏çÂà∞Á¥ÄÈåÑ IDÔºåÁÑ°Ê≥ïÂà™Èô§");
        }
    } catch {
        ElMessage.info("Â∑≤ÂèñÊ∂àÂà™Èô§");
    }
}

// ÂèñÂæóÁï∂ÂâçÂπ¥Êúà YYYY-MM
function getCurrentYearMonth(): string {
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, "0"); // Ë£ú 0
    return `${year}-${month}`;
}

const selectedMonth = ref<string>(getCurrentYearMonth());

function formatDate(ts: number) {
    return new Date(ts).toLocaleString();
}

// ÁØ©ÈÅ∏ÂáΩÂºèÔºöÂïÜÂìÅÂêçÁ®± + Âπ¥Êúà
function filterSales() {
    filteredSales.value = sales.value.filter(sale => {
        // Âπ¥ÊúàÈÅéÊøæ
        let monthMatch = true;
        if (selectedMonth.value) {
            const [year, month] = selectedMonth.value.split("-").map(Number);
            const saleDate = new Date(sale.timestamp);
            monthMatch =
                saleDate.getFullYear() === year && saleDate.getMonth() + 1 === month;
        }

        // ÂïÜÂìÅÂêçÁ®±Ê®°Á≥äÊêúÂ∞ã
        const keywordMatch = searchKeyword.value
            ? sale.items.some(item =>
                item.name.toLowerCase().includes(searchKeyword.value.toLowerCase())
            )
            : true;

        return monthMatch && keywordMatch;
    });
}

async function loadSalesByMonth(selectedMonth: string | null) {
    const salesRef = child(dbRef(db), "sales");
    let salesQuery;

    if (selectedMonth) {
        console.log(selectedMonth)
        const parts = selectedMonth.split("-");
        const year = Number(parts[0]);
        const month = Number(parts[1]);

        // ÂûãÂà•ÂÆâÂÖ®Ê™¢Êü•
        if (isNaN(year) || isNaN(month)) {
            console.warn("ÈÅ∏ÊìáÁöÑÊúà‰ªΩÊ†ºÂºè‰∏çÊ≠£Á¢∫:", selectedMonth);
            return;
        }

        // Ë®àÁÆóÁï∂ÊúàËµ∑ËøÑ timestamp
        const monthStart = new Date(year, month - 1, 1).getTime();
        const monthEnd = new Date(year, month, 0, 23, 59, 59, 999).getTime();

        salesQuery = query(
            salesRef,
            orderByChild("timestamp"),
            startAt(monthStart),
            endAt(monthEnd)
        );
    } else {
        // Â¶ÇÊûúÊ≤íÈÅ∏Êúà‰ªΩÔºåÊäìÂÖ®ÈÉ®
        salesQuery = query(salesRef, orderByChild("timestamp"));
    }

    const snapshot = await get(salesQuery);
    if (snapshot.exists()) {
        const data = snapshot.val();
        sales.value = Object.entries(data).map(([key, val]) => ({
            id: key,   // <- ÈÄôË£°Â≠ò key
            ...(val as Sale)
        })).sort((a, b) => b.timestamp - a.timestamp) as Sale[];

        filterSales();
    } else {
        sales.value = [];
        filteredSales.value = [];
    }
}

// Á∏ΩÈä∑ÂîÆÈ°çÔºàÊ†πÊìöÁØ©ÈÅ∏ÁµêÊûúÔºâ
const totalFilteredSales = computed(() =>
    filteredSales.value.reduce((sum, sale) => sum + sale.total, 0)
);

// Á∏ΩÊØõÂà©ÔºàÊ†πÊìöÁØ©ÈÅ∏ÁµêÊûúÔºâ
const totalFilteredProfit = computed(() =>
    filteredSales.value.reduce((sum, sale) => sum + (sale.totalProfit ?? 0), 0)
);

// Ë®àÁÆó‰ªäÂ§©Èõ∂ÊôÇÈõ∂ÂàÜÈõ∂Áßí
function getTodayStart(): number {
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
}

// ‰ªäÊó•Èä∑ÂîÆÈ°ç
const todaySales = computed(() => {
    const start = getTodayStart();
    return sales.value
        .filter(sale => sale.timestamp >= start)
        .reduce((sum, sale) => sum + sale.total, 0);
});

// ‰ªäÊó•ÊØõÂà©
const todayProfit = computed(() => {
    const start = getTodayStart();
    return sales.value
        .filter(sale => sale.timestamp >= start)
        .reduce((sum, sale) => sum + (sale.totalProfit ?? 0), 0);
});


// ----ÊòéÁ¥∞Á∑®ËºØÁõ∏Èóú----
const showDetailActions = ref(false); // ÂΩàÁ™óÁ∑®ËºØÊ®°ÂºèÈñãÈóú
const editingDetailRow = ref<SaleItem | null>(null);
let currentEditingSaleId: string | null = null; // Ë®òÈåÑÂΩàÁ™óÂ∞çÊáâÁöÑ sale.id

function showDetails(rowItems: SaleItem[], operator: string, total: number, totalProfit: number, saleId?: string) {
    selectedItems.value = rowItems.map(item => ({ ...item })); // Ë§áË£Ω‰∏Ä‰ªΩÔºåÈÅøÂÖçÁõ¥Êé•Á∂ÅÂÆö
    selectedOperator.value = operator;
    selectedTotal.value = total;
    selectedProfit.value = totalProfit || 0;
    dialogVisible.value = true;
    currentEditingSaleId = saleId || null;
    console.log(selectedItems.value)
}

// Êñ∞Â¢ûÂïÜÂìÅÊòéÁ¥∞
function addNewDetailItem() {
    if (!currentEditingSaleId) {
        ElMessage.error("Êâæ‰∏çÂà∞Á¥ÄÈåÑ IDÔºåÁÑ°Ê≥ïÊñ∞Â¢û");
        return;
    }

    const newItem: SaleItem = {
        barcode: `new-${Date.now()}`, // Á∞°ÂñÆÁîüÊàêÂîØ‰∏ÄÊ¢ùÁ¢º
        gtin: '',
        code: '',
        name: '',
        price: 0,
        sellingPrice: 0,
        quantity: 1,
        cost: 0,
        imageUrl: ''
    };

    selectedItems.value.push(newItem);
    editingDetailRow.value = newItem; // Êñ∞Â¢ûÂæåËá™ÂãïÈÄ≤ÂÖ•Á∑®ËºØÊ®°Âºè
    showDetailActions.value = true;   // Á¢∫‰øùÁ∑®ËºØÊ®°ÂºèÈñãÂïü
}

// ÂÑ≤Â≠òÊòéÁ¥∞Á∑®ËºØ
async function saveDetailEdit(item: SaleItem) {
    if (!currentEditingSaleId) {
        ElMessage.error("Êâæ‰∏çÂà∞Á¥ÄÈåÑ IDÔºåÁÑ°Ê≥ïÂÑ≤Â≠ò");
        return;
    }

    // Êõ¥Êñ∞ selectedItems
    const index = selectedItems.value.findIndex(i => i.barcode === item.barcode);
    if (index !== -1) selectedItems.value[index] = { ...item };

    // Ë®àÁÆóÊñ∞ÁöÑÁ∏ΩÈ°ç„ÄÅÊØõÂà©
    const newTotal = selectedItems.value.reduce((sum, i) => sum + (i.sellingPrice * i.quantity), 0);
    const newProfit = selectedItems.value.reduce((sum, i) => sum + ((i.sellingPrice - (i.cost ?? 0)) * i.quantity), 0);

    // Êõ¥Êñ∞ Firebase
    await update(dbRef(db, `sales/${currentEditingSaleId}`), {
        items: selectedItems.value,
        total: newTotal,
        totalProfit: newProfit,
        updater: user.value?.displayName + "(" + getDeviceInfoShort() + ")"
    });

    // Êõ¥Êñ∞ÂΩàÁ™óÈ°ØÁ§∫
    selectedTotal.value = newTotal;
    selectedProfit.value = newProfit;

    // Êõ¥Êñ∞‰∏ªË°®Ê†º
    await loadSalesByMonth(selectedMonth.value);

    ElMessage.success('ÊòéÁ¥∞Â∑≤ÂÑ≤Â≠ò');
    editingDetailRow.value = null;
}

// Âà™Èô§ÊòéÁ¥∞ÂïÜÂìÅÔºàÂ∏∂Á¢∫Ë™çÊèêÁ§∫Ôºâ
function deleteDetailItem(row: SaleItem) {
    ElMessageBox.confirm(
        'Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÂïÜÂìÅÊòéÁ¥∞ÂóéÔºü',
        'Âà™Èô§Á¢∫Ë™ç',
        {
            confirmButtonText: 'Á¢∫ÂÆö',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning',
        }
    )
        .then(() => {
            const index = selectedItems.value.indexOf(row);
            if (index !== -1) {
                selectedItems.value.splice(index, 1);
                ElMessage.success('ÊòéÁ¥∞Â∑≤Âà™Èô§');

                // ÂêåÊ≠•Êõ¥Êñ∞ Firebase
                updateDetailItemsInFirebase();
            }
        })
        .catch(() => {
            ElMessage.info('Â∑≤ÂèñÊ∂àÂà™Èô§');
        });
}

// ÂêåÊ≠•ÊòéÁ¥∞Âà∞ Firebase
async function updateDetailItemsInFirebase() {
    // ‰ΩøÁî®Âú® showDetails ‰∏≠Ë®≠ÂÆöÁöÑ currentEditingSaleId ‰ΩúÁÇ∫ saleId
    const saleId = currentEditingSaleId;
    if (!saleId) return;

    // Ë®àÁÆóÁ∏ΩÈáëÈ°çËàáÊØõÂà©
    const total = selectedItems.value.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
    const totalProfit = selectedItems.value.reduce((sum, item) => sum + ((item.sellingPrice - (item.cost ?? 0)) * item.quantity), 0);

    await update(dbRef(db, `sales/${saleId}`), {
        items: selectedItems.value,
        total,
        totalProfit,
        updater: user.value?.displayName + "(" + getDeviceInfoShort() + ")",
    });

    // Êõ¥Êñ∞‰∏ªË°®Ê†º
    await loadSalesByMonth(selectedMonth.value);
}

function onDetailDialogClose() {
    dialogVisible.value = false;
    showDetailActions.value = false; // ÈÄÄÂá∫Á∑®ËºØÊ®°Âºè
    editingDetailRow.value = null;   // Ê∏ÖÈô§Ê≠£Âú®Á∑®ËºØÁöÑË°å
}

function toggleDetailEditMode() {
    if (showDetailActions.value) {
        // ÈÄÄÂá∫Á∑®ËºØÊ®°Âºè
        editingDetailRow.value = null; // Èö±ËóèÊâÄÊúâÁ∑®ËºØÊ°Ü
        showDetailActions.value = false;
    } else {
        // ÈÄ≤ÂÖ•Á∑®ËºØÊ®°Âºè
        showDetailActions.value = true;
    }
}

onMounted(() => loadSalesByMonth(selectedMonth.value));

</script>

<style scoped>
.titleBar {
    margin: 0 0 10px 0;
}

.title-col {
    text-align: left;
}

.title-col h2 {
    margin: 0;
    font-weight: 600;
}

.top-bar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.search-input {
    flex: 1;
    width: 180px;
}

.action-row {
    display: flex;
}

/* ‚úÖ Â§ñÂ±§ÂÆπÂô®‰∏ÄÂÆöË¶Å block ‰∏î 100% */
.date-picker-wrapper {
    display: block;
    width: 100%;
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    /* ‚úÖ ÂÖÅË®±ÊâãÊ©üËá™ÂãïÊèõË°å */
    gap: 10px;
    margin-bottom: 12px;
}

/* Áµ±Ë®àË≥áË®äÂç°Áâá */
.summary-card {
    flex: 1;
    min-width: 250px;
    border-radius: 10px;
}

/* Âç°ÁâáÂÖßÂÆπÔºöÂèØËá™ÂãïÊèõË°å */
.summary-content {
    display: flex;
    flex-wrap: wrap;
    gap: 10px 20px;
    font-size: 1rem;
    font-weight: 500;
}

.summary-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.highlight {
    color: #409eff;
    font-weight: 600;
}

.profit {
    color: #67c23a;
}

/* ÊåâÈàïÂçÄ */
.summary-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

/* ÊâãÊ©üÊéíÁâàÔºö‰∏ä‰∏ãÊéíÂàó */
@media (max-width: 768px) {
    .detail-header {
        flex-direction: column;
        align-items: stretch;
    }

    .summary-actions {
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .top-bar {
        flex-direction: column;
        align-items: stretch;
    }

    .search-input {
        width: 100%;
    }

    .action-row,
    .button-group {
        width: 100%;
        justify-content: space-between;
    }

    .action-row .el-button,
    .button-group .el-button {
        flex: 1;
    }
}
</style>
